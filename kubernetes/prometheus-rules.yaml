apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: saga-tracker-alerts
  namespace: monitoring
  labels:
    release: prometheus
    app: saga-tracker
spec:
  groups:
    - name: saga-tracker
      rules:
        # 실패 급증 알림
        - alert: SagaFailureSpike
          expr: increase(saga_failed_total[5m]) > 10
          for: 2m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "Saga failure spike detected"
            description: "{{ $value }} sagas failed in the last 5 minutes"
            runbook_url: "https://github.com/GroomC4/c4ang-saga-tracker/blob/main/docs/05-MONITORING.md#51-sagafailurespike-대응"

        # Consumer Lag 알림
        - alert: SagaTrackerConsumerLag
          expr: saga_tracker_consumer_lag > 1000
          for: 10m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "High consumer lag detected"
            description: "Consumer lag is {{ $value }} messages"
            runbook_url: "https://github.com/GroomC4/c4ang-saga-tracker/blob/main/docs/05-MONITORING.md#53-sagatrackerconsumerlag-대응"

        # 서비스 다운 알림
        - alert: SagaTrackerDown
          expr: up{job="saga-tracker-api"} == 0
          for: 1m
          labels:
            severity: critical
            service: saga-tracker
          annotations:
            summary: "Saga Tracker service is down"
            description: "saga-tracker-api has been down for more than 1 minute"

        # API 응답 지연 알림
        - alert: SagaTrackerHighLatency
          expr: histogram_quantile(0.99, rate(http_server_requests_seconds_bucket{job="saga-tracker-api"}[5m])) > 2
          for: 5m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "High API latency detected"
            description: "P99 latency is {{ $value }}s"

        # 보상 지연 알림 (실패 후 5분 내 보상이 없는 경우)
        - alert: SagaCompensationDelay
          expr: |
            (saga_active_total{status="FAILED"} > 0)
            and (increase(saga_compensated_total[5m]) == 0)
          for: 5m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "Saga compensation delayed"
            description: "There are failed sagas that haven't been compensated for more than 5 minutes"
            runbook_url: "https://github.com/GroomC4/c4ang-saga-tracker/blob/main/docs/05-MONITORING.md#52-sagacompensationtimeout-대응"

        # 높은 실패율 알림
        - alert: SagaHighFailureRate
          expr: |
            (rate(saga_failed_total[15m]) / rate(saga_events_processed_total[15m])) > 0.1
          for: 5m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "High saga failure rate"
            description: "Saga failure rate is {{ $value | humanizePercentage }} over the last 15 minutes"

        # 보상 시간 임계치 초과 알림
        - alert: SagaCompensationSlow
          expr: histogram_quantile(0.95, rate(saga_compensation_duration_seconds_bucket[15m])) > 30
          for: 10m
          labels:
            severity: warning
            service: saga-tracker
          annotations:
            summary: "Slow saga compensation detected"
            description: "P95 compensation duration is {{ $value }}s (threshold: 30s)"

        # 이벤트 처리 중단 감지
        - alert: SagaEventProcessingStalled
          expr: rate(saga_events_processed_total[5m]) == 0
          for: 10m
          labels:
            severity: critical
            service: saga-tracker
          annotations:
            summary: "Saga event processing stalled"
            description: "No saga events have been processed in the last 10 minutes"
